---
title: "Humanitarian Country Report"
subtitle: "`r paste(params$country_iso3, '-', params$year)`"
format:
  html:
    toc: true
    code-fold: true
    self-contained: true
    theme: cosmo
params:
  country_iso3: "COL"
  year: 2024
  gp_provider: "openai"
  gp_model: "gpt-4o-mini"
  package_path: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(dplyr)
library(ellmer)
library(unhcrdatapackage)
library(unhcrreports) 

# Fix font issue on Windows
update_geom_defaults("text", list(family = "sans"))
update_geom_defaults("label", list(family = "sans"))
theme_set(theme_gray(base_family = "sans"))

if (!is.null(params$package_path)) {
  pkgload::load_all(params$package_path)
} else if (file.exists("../../DESCRIPTION")) {
  pkgload::load_all("../../")
}
```

```{r setup_data, include=FALSE}
# --- Pre-calculate Plots and Stories ---

# 1. Key Figures
p_key <- plot_ctr_keyfig(year = params$year, country_asylum_iso3c = params$country_iso3)
# No story for key figures usually, or simple one
story_key <- "" 

# 2. Population Overview
p_tree <- plot_ctr_treemap(year = params$year, country_asylum_iso3c = params$country_iso3)
story_tree <- generate_plot_story(p_tree, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_pyramid <- plot_ctr_pyramid(year = params$year, country_asylum_iso3c = params$country_iso3, pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"))
story_pyramid <- generate_plot_story(p_pyramid, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_trend <- plot_ctr_population_type_per_year(year = params$year, country_asylum_iso3c = params$country_iso3)
story_trend <- generate_plot_story(p_trend, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_diff <- plot_ctr_diff_in_pop_groups(year = params$year, country_asylum_iso3c = params$country_iso3, pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"))
story_diff <- generate_plot_story(p_diff, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_perc <- plot_ctr_population_type_perc(year = params$year, country_asylum_iso3c = params$country_iso3, pop_type = "REF")
story_perc <- generate_plot_story(p_perc, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

# Section Summary: Population
summary_pop <- generate_section_summary(
  stories = c(story_tree, story_pyramid, story_trend, story_diff, story_perc),
  section_name = "Population Overview",
  provider = params$gp_provider,
  model = params$gp_model
)

# 3. Geography & Movements
p_map <- plot_ctr_location(year = params$year, country_asylum_iso3c = params$country_iso3)
story_map <- generate_plot_story(p_map, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_origin <- plot_ctr_population_type_abs(year = params$year, country_asylum_iso3c = params$country_iso3, pop_type = "REF")
story_origin <- generate_plot_story(p_origin, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_hist <- plot_ctr_origin_history(year = params$year, country_asylum_iso3c = params$country_iso3)
story_hist <- generate_plot_story(p_hist, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_dest <- plot_ctr_destination(year = params$year, country_origin_iso3c = params$country_iso3)
story_dest <- generate_plot_story(p_dest, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

# Section Summary: Geography
summary_geo <- generate_section_summary(
  stories = c(story_map, story_origin, story_hist, story_dest),
  section_name = "Geography & Movements",
  provider = params$gp_provider,
  model = params$gp_model
)

# 4. Asylum System
p_asylum <- plot_ctr_asylum(year = params$year, country_asylum_iso3c = params$country_iso3)
story_asylum <- generate_plot_story(p_asylum, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_process <- plot_ctr_process(year = params$year, country_asylum_iso3c = params$country_iso3)
story_process <- generate_plot_story(p_process, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_time <- plot_ctr_processing_time(year = params$year, country_asylum_iso3c = params$country_iso3)
story_time <- generate_plot_story(p_time, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_rec <- plot_ctr_recognition(year = params$year, country_asylum_iso3c = params$country_iso3)
story_rec <- generate_plot_story(p_rec, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

p_rec_origin <- plot_ctr_origin_recognition(year = params$year, country_origin_iso3c = params$country_iso3)
story_rec_origin <- generate_plot_story(p_rec_origin, provider = params$gp_provider, model = params$gp_model, max_tokens = 200)

# Section Summary: Asylum
summary_asylum <- generate_section_summary(
  stories = c(story_asylum, story_process, story_time, story_rec, story_rec_origin),
  section_name = "Asylum System",
  provider = "openai"
)

# 5. Solutions
p_sol <- plot_ctr_solution(year = params$year, country_asylum_iso3c = params$country_iso3, sol_type = c("NAT", "RST", "RET", "RDP"))
story_sol <- generate_plot_story(p_sol, provider = "openai", max_tokens = 200)

# Section Summary: Solutions
summary_sol <- generate_section_summary(
  stories = c(story_sol),
  section_name = "Solutions",
  provider = "openai"
)

# 6. Report Summary
summary_report <- generate_report_summary(
  section_summaries = list(
    "Population Overview" = summary_pop,
    "Geography & Movements" = summary_geo,
    "Asylum System" = summary_asylum,
    "Solutions" = summary_sol
  ),
  country_name = params$country_iso3,
  year = params$year,
  provider = "openai"
)
```

# Executive Summary

`r summary_report`

```{r key-figures}
#| fig.width: 10
#| fig.height: 4
p_key
```

# Population Overview

`r summary_pop`

## Demographics

```{r treemap}
#| fig.width: 10
#| fig.height: 6
p_tree
```

> **AI Insight**: `r story_tree`

```{r pyramid}
#| fig.width: 10
#| fig.height: 8
p_pyramid
```

> **AI Insight**: `r story_pyramid`

## Trends Over Time

```{r trends}
#| fig.width: 10
#| fig.height: 6
p_trend
```

> **AI Insight**: `r story_trend`

```{r diff-pop}
#| fig.width: 10
#| fig.height: 6
p_diff
```

> **AI Insight**: `r story_diff`

```{r pop-perc}
#| fig.width: 10
#| fig.height: 6
p_perc
```

> **AI Insight**: `r story_perc`

# Geography & Movements

`r summary_geo`

```{r map}
#| fig.width: 10
#| fig.height: 8
p_map
```

> **AI Insight**: `r story_map`

## Origin of Displaced Populations

```{r origin}
#| fig.width: 10
#| fig.height: 8
p_origin
```

> **AI Insight**: `r story_origin`

```{r origin-history}
#| fig.width: 10
#| fig.height: 6
p_hist
```

> **AI Insight**: `r story_hist`

## Destination

```{r destination}
#| fig.width: 10
#| fig.height: 6
# Note: This plot shows where people FROM the country go (Outflow)
p_dest
```

> **AI Insight**: `r story_dest`

# Asylum System

`r summary_asylum`

```{r asylum}
#| fig.width: 10
#| fig.height: 6
p_asylum
```

> **AI Insight**: `r story_asylum`

```{r process}
#| fig.width: 10
#| fig.height: 8
p_process
```

> **AI Insight**: `r story_process`

```{r processing-time}
#| fig.width: 10
#| fig.height: 6
p_time
```

> **AI Insight**: `r story_time`

## Recognition Rates

```{r recognition}
#| fig.width: 10
#| fig.height: 8
p_rec
```

> **AI Insight**: `r story_rec`

```{r origin-recognition}
#| fig.width: 10
#| fig.height: 8
# Note: This plot shows recognition rates for nationals FROM the country (Outflow)
p_rec_origin
```

> **AI Insight**: `r story_rec_origin`

# Solutions

`r summary_sol`

```{r solutions}
#| fig.width: 10
#| fig.height: 6
p_sol
```

> **AI Insight**: `r story_sol`

