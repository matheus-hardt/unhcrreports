---
title: "Humanitarian Country Report"
subtitle: "`r paste(params$country_iso3, '-', params$year)`"
author: "AI Generated Analysis based on [UNHCR Forced Displacement Statisitics](https://www.unhcr.org/refugee-statistics). Beware of data limitations and potential hallucinations! Thanks for reporting any [issues here](https://github.com/matheus-hardt/unhcrreports/issues/new) -- [View all Reports](../articles/ai-powered-reports.html)"
format:
  html:
    toc: true
    code-fold: true
    self-contained: true
    theme: cosmo
params:
  country_iso3: "BRA"
  name: "Brazil"
  year: 2024
  gp_provider: "azure"
  gp_model: "gpt-4.1-mini"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dev = "svg", out.width = "100%")
library(ggplot2)
library(dplyr)
library(ellmer)

library(unhcrreports)
library(unhcrviz) 

# Fix font issue on Windows
update_geom_defaults("text", list(family = "sans"))
update_geom_defaults("label", list(family = "sans"))
theme_set(theme_gray(base_family = "sans"))


```

```{r setup_data, include=FALSE}
# --- Pre-calculate Plots and Stories ---


# 1. Key Figures
p_key <- plot_ctr_keyfig(year = params$year,
                         country_asylum_iso3c = params$country_iso3)
# No story for key figures usually, or simple one
story_key <- ""

# 2. Population Overview
p_tree <- plot_ctr_treemap(year = params$year,
                           country_asylum_iso3c = params$country_iso3)
story_tree <- generate_plot_story(
  p_tree,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_pyramid <- plot_ctr_pyramid(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")
)
story_pyramid <- generate_plot_story(
  p_pyramid,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_trend <- plot_ctr_population_type_per_year(year = params$year,
                                             country_asylum_iso3c = params$country_iso3)
story_trend <- generate_plot_story(
  p_trend,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_diff <- plot_ctr_diff_in_pop_groups(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")
)
story_diff <- generate_plot_story(
  p_diff,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_perc <- plot_ctr_population_type_perc(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = "REF"
)
story_perc <- generate_plot_story(
  p_perc,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

# Section Summary: Population
summary_pop <- generate_section_summary(
  stories = c(story_tree, story_pyramid, story_trend, story_diff, story_perc),
  section_name = "Population Overview",
  provider = params$gp_provider,
  model = params$gp_model
)

# 3. Geography & Movements
p_map <- plot_ctr_location(year = params$year,
                           country_asylum_iso3c = params$country_iso3)
story_map <- generate_plot_story(
  p_map,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_origin <- plot_ctr_population_type_abs(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = "REF"
)
story_origin <- generate_plot_story(
  p_origin,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_hist <- plot_ctr_origin_history(year = params$year,
                                  country_asylum_iso3c = params$country_iso3)
story_hist <- generate_plot_story(
  p_hist,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_dest <- plot_ctr_destination(year = params$year,
                               country_origin_iso3c = params$country_iso3)
story_dest <- generate_plot_story(
  p_dest,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_migrant <- unhcrviz::plot_ctr_disp_migrant(year = params$year,
                               country_asylum_iso3c = params$country_iso3)
story_migrant <- generate_plot_story(
  p_migrant,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

# Section Summary: Geography
summary_geo <- generate_section_summary(
  stories = c(story_map, story_origin, story_hist, story_dest, story_migrant),
  section_name = "Geography & Movements",
  provider = params$gp_provider,
  model = params$gp_model
)

# 4. Asylum System
p_asylum <- plot_ctr_asylum(year = params$year,
                            country_asylum_iso3c = params$country_iso3)
story_asylum <- generate_plot_story(
  p_asylum,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_process <- plot_ctr_process(year = params$year,
                              country_asylum_iso3c = params$country_iso3)
story_process <- generate_plot_story(
  p_process,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_time <- plot_ctr_processing_time(year = params$year,
                                   country_asylum_iso3c = params$country_iso3)
story_time <- generate_plot_story(
  p_time,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_rec <- plot_ctr_recognition(year = params$year,
                              country_asylum_iso3c = params$country_iso3)
story_rec <- generate_plot_story(
  p_rec,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

p_rec_origin <- plot_ctr_origin_recognition(year = params$year,
                                            country_origin_iso3c = params$country_iso3)
story_rec_origin <- generate_plot_story(
  p_rec_origin,
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200
)

# Section Summary: Asylum
summary_asylum <- generate_section_summary(
  stories = c(
    story_asylum,
    story_process,
    story_time,
    story_rec,
    story_rec_origin
  ),
  section_name = "Asylum System",
  provider = params$gp_provider,
  model = params$gp_model,
)

# 5. Solutions
p_sol <- plot_ctr_solution(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  sol_type = c("NAT", "RST", "RET", "RDP")
)
story_sol <- generate_plot_story(p_sol, 
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200)

p_sol_rec <- unhcrviz::plot_ctr_solution_recognition(
  year = params$year,
  country_asylum_iso3c = params$country_iso3
)
story_sol_rec <- generate_plot_story(p_sol_rec, 
  provider = params$gp_provider,
  model = params$gp_model,
  max_tokens = 200)

# Section Summary: Solutions
summary_sol <- generate_section_summary(
  stories = c(story_sol, story_sol_rec),
  section_name = "Solutions",
  provider = params$gp_provider,
  model = params$gp_model
)

# 6. Report Summary
summary_report <- generate_report_summary(
  section_summaries = list(
    "Population Overview" = summary_pop,
    "Geography & Movements" = summary_geo,
    "Asylum System" = summary_asylum,
    "Solutions" = summary_sol
  ),
  country_name = params$country_iso3,
  year = params$year,
  provider = params$gp_provider,
  model = params$gp_model
)
```

# Executive Summary

`r summary_report`

```{r key-figures}
#| fig.width: 6
#| fig.height: 2.4
p_key
```

# Population Overview

`r summary_pop`

## Demographics

> **AI Insight**: `r story_tree`

```{r treemap}
#| fig.width: 6
#| fig.height: 3.6
p_tree
```

> **AI Insight**: `r story_pyramid`

```{r pyramid}
#| fig.width: 6
#| fig.height: 4.8
p_pyramid
```

## Trends Over Time

> **AI Insight**: `r story_trend`

```{r trends}
#| fig.width: 6
#| fig.height: 7
p_trend
```

> **AI Insight**: `r story_diff`

```{r diff-pop}
#| fig.width: 6
#| fig.height: 6
p_diff
```

> **AI Insight**: `r story_perc`

```{r pop-perc}
#| fig.width: 6
#| fig.height: 7
p_perc
```

# Geography & Movements

`r summary_geo`

> **AI Insight**: `r story_map`

```{r map}
#| fig.width: 6
#| fig.height: 4.8
p_map
```

## Origin of Displaced Populations

> **AI Insight**: `r story_origin`

```{r origin}
#| fig.width: 6
#| fig.height: 6
p_origin
```

> **AI Insight**: `r story_hist`

```{r origin-history}
#| fig.width: 6
#| fig.height: 6
p_hist
```

## Destination

> **AI Insight**: `r story_dest`

```{r destination}
#| fig.width: 6
#| fig.height: 6
# Note: This plot shows where people FROM the country go (Outflow)
p_dest
```

```

> **AI Insight**: `r story_migrant`

```{r migrant}
#| fig.width: 10
#| fig.height: 6
#| warning: false
p_migrant
```

# Asylum System

`r summary_asylum`

> **AI Insight**: `r story_asylum`

```{r asylum}
#| fig.width: 6
#| fig.height: 6
p_asylum
```

> **AI Insight**: `r story_process`

```{r process}
#| fig.width: 6
#| fig.height: 4.8
p_process
```

> **AI Insight**: `r story_time`

```{r processing-time}
#| fig.width: 6
#| fig.height: 6
p_time
```

## Recognition Rates

> **AI Insight**: `r story_rec`

```{r recognition}
#| fig.width: 6
#| fig.height: 6
p_rec
```

> **AI Insight**: `r story_rec_origin`

```{r origin-recognition}
#| fig.width: 6
#| fig.height: 6
# Note: This plot shows recognition rates for nationals FROM the country (Outflow)
p_rec_origin
```

# Solutions

`r summary_sol`

> **AI Insight**: `r story_sol`

```{r solutions}
#| fig.width: 6
#| fig.height: 6
p_sol
```

> **AI Insight**: `r story_sol_rec`

```{r solutions-rec}
#| fig.width: 8
#| fig.height: 6
p_sol_rec
```

