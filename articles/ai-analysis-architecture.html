<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>AI Analysis Architecture • unhcrreports</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Lato-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="AI Analysis Architecture">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">unhcrreports</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Get Started</h6></li>
    <li><a class="dropdown-item" href="../articles/get-started.html">Get Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/matheus-hardt/unhcrreports/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>AI Analysis Architecture</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/matheus-hardt/unhcrreports/blob/main/vignettes/ai-analysis-architecture.Rmd" class="external-link"><code>vignettes/ai-analysis-architecture.Rmd</code></a></small>
      <div class="d-none name"><code>ai-analysis-architecture.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://matheus-hardt.github.io/unhcrreports">unhcrreports</a></span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/flat_ai_reporting.Rmd: do not edit by hand -->
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><code>unhcrreports</code> uses a modular, three-tier architecture to
generate “AI Insights” for data visualizations. This ensures that the
narratives are not just generic text but are grounded in the specific
structure and statistics of the plot.</p>
<ol style="list-style-type: decimal">
<li>
<strong>Structure</strong>: Extracting what the user <em>sees</em>
(axes, legends, titles).</li>
<li>
<strong>Statistics</strong>: Profiling the <em>data</em>
(distributions, correlations).</li>
<li>
<strong>Semantics</strong>: Using an LLM to synthesize this into a
<em>story</em>.</li>
</ol>
</div>
<div class="section level2">
<h2 id="using-language-models-to-build-data-stories">Using Language Models to build data stories<a class="anchor" aria-label="anchor" href="#using-language-models-to-build-data-stories"></a>
</h2>
<div class="section level3">
<h3 id="clean_llm_response">clean_llm_response<a class="anchor" aria-label="anchor" href="#clean_llm_response"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"&lt;think&gt;</span></span>
<span><span class="st">First, I'm a humanitarian data visualization expert. My role includes extracting insights</span></span>
<span><span class="st">from visualizations, creating accessible narratives, highlighting patterns relevant to aid</span></span>
<span><span class="st">efforts, using clear language with emotional resonance.</span></span>
<span><span class="st">Aligning with constraints: Use plain language, be concise and impactful. Don't rehash</span></span>
<span><span class="st">every detail; build narrative depth around 2 key insights maximum in under 30 tokens.</span></span>
<span><span class="st">&lt;/think&gt;</span></span>
<span><span class="st">This visualization tracks a relationship potentially critical for humanitarian logistics:</span></span>
<span><span class="st">higher fuel consumption versus increased weight. 车辆设计"</span></span>
<span><span class="fu"><a href="../reference/clean_llm_response.html">clean_llm_response</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "This visualization tracks a relationship potentially critical for humanitarian logistics: higher fuel consumption versus increased weight."</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="three-tier-architecture-for-ai-reporting">Three-Tier Architecture for AI Reporting<a class="anchor" aria-label="anchor" href="#three-tier-architecture-for-ai-reporting"></a>
</h2>
<p>The AI reporting toolkit uses a modular architecture to analyze
ggplot2 objects and generate context-aware narratives. This approach
ensures that the description is grounded in the actual visual structure
and data of the plot.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Phase 1: Structural Extractor
(<code>extract_structure</code>)</strong> Interrogates the rendered plot
object (using <code>ggplot_build</code>) to retrieve “trained” metadata,
such as exact axis ranges, visible labels, and legend mappings. This is
the “ground truth” of what the user sees.</p></li>
<li><p><strong>Phase 2: Statistical Profiler
(<code>profile_data</code>)</strong> Summarizes the underlying data
distributions and, where appropriate (e.g., scatterplots), calculates
statistical relationships like correlations. This provides the “data
context” that might not be immediately obvious visually.</p></li>
<li><p><strong>Phase 3: Semantic Generator
(<code>generate_description</code>)</strong> Combines the structural
metadata and statistical profile into a structured prompt for the LLM.
It returns a JSON object containing a WCAG-compliant short description
(alt text) and a detailed long description.</p></li>
</ol>
<div class="section level3">
<h3 id="extract_structure">extract_structure<a class="anchor" aria-label="anchor" href="#extract_structure"></a>
</h3>
</div>
<div class="section level3">
<h3 id="profile_data">profile_data<a class="anchor" aria-label="anchor" href="#profile_data"></a>
</h3>
</div>
<div class="section level3">
<h3 id="generate_description">generate_description<a class="anchor" aria-label="anchor" href="#generate_description"></a>
</h3>
</div>
<div class="section level3">
<h3 id="generate_plot_story">generate_plot_story<a class="anchor" aria-label="anchor" href="#generate_plot_story"></a>
</h3>
<pre><code>  

``` r
library(ggplot2)
p &lt;- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", axis_title = FALSE) +
  labs(
    title = "Vehicle Efficiency",
    subtitle = "Fuel consumption vs weight",
    caption = "Source: mtcars dataset"
  )

generate_plot_story(p, provider = "ollama", model = "deepseek-r1")

story &lt;- generate_plot_story(p, provider = "azure", model = "gpt-4.1-mini", max_tokens = 300)
# To use as subtitle:
p + ggplot2::labs(subtitle = story)</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="report-rendering">Report Rendering<a class="anchor" aria-label="anchor" href="#report-rendering"></a>
</h2>
<div class="section level3">
<h3 id="slugify">slugify<a class="anchor" aria-label="anchor" href="#slugify"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">strings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Café au Lait"</span>, <span class="st">"Niño Español"</span>, <span class="st">"Data_Science_Project"</span>, <span class="st">"--test--string--"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/slugify.html">slugify</a></span><span class="op">(</span><span class="va">strings</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cafe-au-lait"         "nino-espanol"         "data-science-project"</span></span>
<span><span class="co">#&gt; [4] "test-string"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-section-summary">Generate Section Summary<a class="anchor" aria-label="anchor" href="#generate-section-summary"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate_section_summary()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-report-summary">Generate Report Summary<a class="anchor" aria-label="anchor" href="#generate-report-summary"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate_report_summary()</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="refresh-package">Refresh package<a class="anchor" aria-label="anchor" href="#refresh-package"></a>
</h2>
<!--
# There can be development actions

Create a chunk with 'development' actions

- The chunk needs to be named `development` or `dev`
- It contains functions that are used for package development only
- Note that you may want to store most of these functions in the 0-dev_history.Rmd file

These are only included in the present flat template file, their content will not be part of the package anywhere else.
-->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matheus Hardt.</p>
</div>

<div class="pkgdown-footer-right">
  <p><a href="https://www.unhcr.org/" target="_blank" rel="noopener noreferrer" class="external-link"><img src="https://raw.githubusercontent.com/unhcr-dataviz/unhcrtemplate/master/man/figures/logo.svg" alt="UNHCR logo" style="max-height:2.5rem"></a></p>
</div>

    </footer>
</div>





  </body>
</html>
