---
title: "Playground: Humanitarian Country Report 5"
subtitle: "Manual Testing of Plots"
format:
  html:
    embed-resources: true
params:
  country_iso3: "BRA"
  name: "Brazil"
  year: 2024
  lag: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, dev = "svg", out.width = "100%")
library(ggplot2)
library(dplyr)
library(unhcrreports)
library(unhcrviz)

# Fix font issue on Windows
update_geom_defaults("text", list(family = "sans"))
update_geom_defaults("label", list(family = "sans"))
theme_set(theme_gray(base_family = "sans"))
```

```{r setup_data, include=FALSE}
# --- Pre-calculate Plots (AI Stories Disabled) ---

# 1. Key Figures
p_key <- plot_ctr_keyfig(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  population_type_font_size = 3,
  population_size_font_size = 4,
  icon_size = 22
)
story_key <- ""

# 2. Population Overview
p_tree <- plot_ctr_treemap(
  year = params$year,
  country_asylum_iso3c = params$country_iso3
)
story_tree <- generate_plot_story(p_tree, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_pyramid <- plot_ctr_pyramid(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")
)
story_pyramid <- generate_plot_story(p_pyramid, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_trend <- plot_ctr_population_type_per_year(
  year = params$year,
  lag = params$lag,
  country_asylum_iso3c = params$country_iso3
)
story_trend <- generate_plot_story(p_trend, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_diff <- plot_ctr_diff_in_pop_groups(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"),
  category_font_size = 1
)
story_diff <- generate_plot_story(p_diff, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_perc <- plot_ctr_population_type_perc(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = "REF"
)
story_perc <- generate_plot_story(p_perc, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

# Section Summary: Population
summary_pop <- generate_section_summary(
  stories = c(story_tree, story_pyramid, story_trend, story_diff, story_perc),
  section_name = "Population Overview",
  provider = "gemini", 
  model = "gemini-3-pro-preview"
)

# 3. Geography & Movements
p_map <- plot_ctr_location(
  year = params$year,
  country_origin_iso3c = params$country_iso3,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC")
)
story_map <- generate_plot_story(p_map, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_origin <- plot_ctr_population_type_abs(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  pop_type = "REF"
)
story_origin <- generate_plot_story(p_origin, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_hist <- plot_ctr_origin_history(
  year = params$year,
  country_asylum_iso3c = params$country_iso3
)
story_hist <- generate_plot_story(p_hist, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_dest <- plot_ctr_destination(
  year = params$year,
  country_origin_iso3c = params$country_iso3
)
story_dest <- generate_plot_story(p_dest, provider = "gemini", model = "gemini-3-pro-preview")$long_desc


# Section Summary: Geography
summary_geo <- generate_section_summary(
  stories = c(story_map, story_origin, story_hist, story_dest),
  section_name = "Geography & Movements",
  provider = "gemini",
  model = "gemini-3-pro-preview"
)

# 4. Asylum System
p_asylum <- plot_ctr_asylum(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  lag = params$lag
)
story_asylum <- generate_plot_story(p_asylum, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_process <- plot_ctr_process(
  year = params$year,
  country_asylum_iso3c = params$country_iso3
)
story_process <- generate_plot_story(p_process, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_time <- plot_ctr_processing_time(
  year = params$year,
  lag = params$lag,
  country_asylum_iso3c = params$country_iso3
)
story_time <- generate_plot_story(p_time, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_rec <- plot_ctr_recognition(
  year = params$year,
  country_asylum_iso3c = params$country_iso3
)
story_rec <- generate_plot_story(p_rec, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_rec_origin <- plot_ctr_origin_recognition(
  year = params$year,
  country_origin_iso3c = params$country_iso3
)
story_rec_origin <- generate_plot_story(p_rec_origin, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

# Section Summary: Asylum
summary_asylum <- generate_section_summary(
  stories = c(story_asylum, story_process, story_time, story_rec, story_rec_origin),
  section_name = "Asylum System",
  provider = "gemini",
  model = "gemini-3-pro-preview"
)

# 5. Solutions
p_sol <- plot_ctr_solution(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  sol_type = c("NAT", "RST", "RET", "RDP"),
  lag = params$lag  
)
story_sol <- generate_plot_story(p_sol, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

p_sol_rec <- unhcrviz::plot_ctr_solution_recognition(
  year = params$year,
  country_asylum_iso3c = params$country_iso3,
  lag = params$lag
)
story_sol_rec <- generate_plot_story(p_sol_rec, provider = "gemini", model = "gemini-3-pro-preview")$long_desc

# Section Summary: Solutions
summary_sol <- generate_section_summary(
  stories = c(story_sol, story_sol_rec),
  section_name = "Solutions",
  provider = "gemini",
  model = "gemini-3-pro-preview"
)

# 6. Report Summary
summary_report <- generate_report_summary(
  section_summaries = c(
    "Population Overview" = summary_pop,
    "Geography & Movements" = summary_geo,
    "Asylum System" = summary_asylum,
    "Solutions" = summary_sol
  ),
  country_name = params$name,
  year = params$year,
  provider = "gemini",
  model = "gemini-3-pro-preview"
)
```

# Executive Summary

`r summary_report`

```{r key-figures}
#| fig.width: 5
#| fig.height: 8
#| echo: false
#| message: false
#| warning: false

p_key
```

# Population Overview

`r summary_pop`

## Demographics

> **AI Insight**: `r story_tree`

```{r treemap}
#| fig.width: 6
#| fig.height: 4
#| echo: false
#| message: false
#| warning: false

p_tree
```

> **AI Insight**: `r story_pyramid`

```{r pyramid}
#| fig.width: 6
#| fig.height: 4.8
#| echo: false
#| message: false
#| warning: false

p_pyramid
```

## Trends Over Time

> **AI Insight**: `r story_trend`

```{r trends}
#| fig.width: 6
#| fig.height: 7
#| echo: false
#| message: false
#| warning: false

p_trend
```

> **AI Insight**: `r story_diff`

```{r diff-pop}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_diff
```

> **AI Insight**: `r story_perc`

```{r pop-perc}
#| fig.width: 6
#| fig.height: 7
#| echo: false
#| message: false
#| warning: false

p_perc
```

# Geography & Movements

`r summary_geo`

> **AI Insight**: `r story_map`

```{r map}
#| fig.width: 6
#| fig.height: 4.8
#| echo: false
#| message: false
#| warning: false

p_map
```

## Origin of Displaced Populations

> **AI Insight**: `r story_origin`

```{r origin}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_origin
```

> **AI Insight**: `r story_hist`

```{r origin-history}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_hist
```

## Destination

> **AI Insight**: `r story_dest`

```{r destination}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_dest
```

# Asylum System

`r summary_asylum`

> **AI Insight**: `r story_asylum`

```{r asylum}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_asylum
```

> **AI Insight**: `r story_process`

```{r process}
#| fig.width: 6
#| fig.height: 4.8
#| echo: false
#| message: false
#| warning: false

p_process
```

> **AI Insight**: `r story_time`

```{r processing-time}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_time
```

## Recognition Rates

> **AI Insight**: `r story_rec`

```{r recognition}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_rec
```

> **AI Insight**: `r story_rec_origin`

```{r origin-recognition}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_rec_origin
```

# Solutions

`r summary_sol`

> **AI Insight**: `r story_sol`

```{r solutions}
#| fig.width: 6
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false

p_sol
```

> **AI Insight**: `r story_sol_rec`

```{r solutions-rec}
#| fig.width: 8
#| fig.height: 6
#| echo: false
#| message: false
#| warning: false
p_sol_rec
```
